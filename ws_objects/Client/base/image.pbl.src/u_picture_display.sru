$PBExportHeader$u_picture_display.sru
forward
global type u_picture_display from userobject
end type
type p_hidden_picture from picture within u_picture_display
end type
type st_na from statictext within u_picture_display
end type
type ole_control from u_ole_control within u_picture_display
end type
type ole_browser from u_browser within u_picture_display
end type
type p_picture from picture within u_picture_display
end type
end forward

global type u_picture_display from userobject
integer width = 1211
integer height = 1068
long backcolor = 67108864
string text = "none"
long tabtextcolor = 33554432
long picturemaskcolor = 536870912
event picture_clicked ( )
p_hidden_picture p_hidden_picture
st_na st_na
ole_control ole_control
ole_browser ole_browser
p_picture p_picture
end type
global u_picture_display u_picture_display

type variables
string picture_file

long picture_width
long picture_height

boolean zoomable
boolean zoom_on

end variables

forward prototypes
public function integer display_picture (string ps_picture_file)
private subroutine display_native (string ps_imagefile)
public function integer view_image ()
public subroutine clear_image ()
public subroutine initialize ()
end prototypes

public function integer display_picture (string ps_picture_file);string ls_drive
string ls_directory
string ls_filename
string ls_extension
string ls_display_control

picture_file = ps_picture_file

f_parse_filepath(picture_file, ls_drive, ls_directory, ls_filename, ls_extension)

ls_display_control = datalist.extension_display_control(ls_extension)

CHOOSE CASE upper(ls_display_control)
	CASE "PICTURE"
		st_na.visible = false
		ole_browser.visible = false
		ole_control.visible = false
		p_picture.visible = true		
		display_native(picture_file)
	CASE "ACTIVEX"
		ole_control.insertfile(picture_file)
		st_na.visible = false
		ole_browser.visible = false
		ole_control.visible = true
		p_picture.visible = false
	CASE "BROWSER"
		ole_browser.visible = true
		st_na.visible = false
		ole_control.visible = false
		p_picture.visible = false
		ole_browser.object.height = unitstopixels(picture_height, YUnitsToPixels!)
		ole_browser.object.width = unitstopixels(picture_width, XUnitsToPixels!)
		ole_browser.object.navigate(picture_file)
	CASE ELSE
		st_na.text = "This type of file (" + ls_extension + ") cannot be visually displayed."
		st_na.visible = true
		ole_browser.visible = false
		ole_control.visible = false
		p_picture.visible = false
END CHOOSE

return 1

end function

private subroutine display_native (string ps_imagefile);long ll_height
long ll_width
real lr_picture_aspect
real lr_display_aspect
string ls_drive
string ls_directory
string ls_filename
string ls_extension
string ls_picturefile
integer li_sts
boolean lb_converted
long ll_picture_pixels_x
long ll_picture_pixels_y
long ll_picture_hresolution
long ll_picture_vresolution


f_parse_filepath(ps_imagefile, ls_drive, ls_directory, ls_filename, ls_extension)

if lower(ls_extension) = "tif" or lower(ls_extension) = "tiff" then
	li_sts = f_convert_tiff_to_bmp(ps_imagefile, ls_picturefile)
	if li_sts <= 0 then
		if li_sts = -99 then
			st_na.text = "Unable to display TIF file as a bitmap."
			st_na.text += "~r~n~r~nThis is probably because the TIF file uses LZW compression which is not yet supported natively by EncounterPRO."
			st_na.text += "~r~n~r~nFile may still be attached to a patient chart and displayed from within the patient chart."
		else
			st_na.text = "Error converting TIF file to bitmap for display."
		end if
		st_na.visible = true
		p_Picture.visible = false
		return
	end if
	lb_converted = true
	display_picture(ls_picturefile)
	return
else
	ls_picturefile = ps_imagefile
	lb_converted = false
end if

if isnull(ls_picturefile) or trim(ls_picturefile) = "" then return
if not fileexists(ls_picturefile) then return

f_get_picture_info(ls_picturefile, ll_picture_pixels_x, ll_picture_pixels_y, ll_picture_hresolution, ll_picture_vresolution)
ll_width = pixelstounits(ll_picture_pixels_x, XPixelsToUnits! )
ll_height = pixelstounits(ll_picture_pixels_y, YPixelsToUnits! )

IF ll_width = 0 or ll_height = 0 THEN return

//p_hidden_picture.picturename = ls_picturefile
//p_hidden_picture.originalsize = true

//ll_height = p_hidden_picture.height
//ll_width = p_hidden_picture.width

p_picture.picturename = ""

lr_picture_aspect = real(ll_height) / real(ll_width)
lr_display_aspect = real(picture_height) / real(picture_width)

if lr_display_aspect > lr_picture_aspect then
	// In this case the aspect ratio of the actual picture is less than the
	// aspect ratio of the display, so make the picture as wide as the display but shorten
	// the height.
	p_picture.width = picture_width
	p_picture.height = picture_width * lr_picture_aspect
	p_picture.x = 0
	p_picture.y = (picture_height - p_picture.height) / 2
else
	// In this case the aspect ratio of the actual picture is greater than the
	// aspect ratio of the display, so make the picture as wide as the display but shorten
	// the height.
	p_picture.height = picture_height
	IF lr_picture_aspect > 0 THEN p_picture.width = picture_height / lr_picture_aspect
	p_picture.x = (picture_width - p_picture.width) / 2
	p_picture.y = 0
end if

p_picture.picturename = ls_picturefile

if lb_converted then
	filedelete(ls_picturefile)
end if

end subroutine

public function integer view_image ();oleobject luo_ImageViewer
integer li_sts

if isnull(picture_file) or trim(picture_file) = "" then return 0

f_open_file(picture_file, false)

//luo_ImageViewer = CREATE oleobject
//li_sts = luo_ImageViewer.connecttonewobject("EPImageViewer.Image")
//if li_sts < 0 then
//	DESTROY luo_ImageViewer
//	log.log(this, "u_picture_display.view_image:0012", "Error creating ImageViewer object (" + string(li_sts) + ")", 4)
//	return -1
//end if
//
//luo_ImageViewer.LoadImageFromFile(picture_file, true)
//
//luo_ImageViewer.disconnectobject()
//
//DESTROY luo_ImageViewer
//

return 1


end function

public subroutine clear_image ();st_na.visible = false
ole_browser.visible = false
ole_control.visible = false
p_picture.visible = false		

end subroutine

public subroutine initialize ();

if vScrollBar then
	picture_width = width - 100
	picture_height = height * 2
else
	picture_width = width
	picture_height = height
end if

ole_browser.width = picture_width
ole_control.width = picture_width
p_picture.width = picture_width
st_na.width = picture_width

ole_browser.height = picture_height
ole_control.height = picture_height
p_picture.height = picture_height
st_na.height = picture_height

//ole_browser.object.height = unitstopixels(picture_height, YUnitsToPixels!)
//ole_browser.object.width = unitstopixels(picture_width, XUnitsToPixels!)

st_na.text = ""


end subroutine

on u_picture_display.create
this.p_hidden_picture=create p_hidden_picture
this.st_na=create st_na
this.ole_control=create ole_control
this.ole_browser=create ole_browser
this.p_picture=create p_picture
this.Control[]={this.p_hidden_picture,&
this.st_na,&
this.ole_control,&
this.ole_browser,&
this.p_picture}
end on

on u_picture_display.destroy
destroy(this.p_hidden_picture)
destroy(this.st_na)
destroy(this.ole_control)
destroy(this.ole_browser)
destroy(this.p_picture)
end on

event constructor;initialize()

end event

type p_hidden_picture from picture within u_picture_display
boolean visible = false
integer width = 165
integer height = 144
boolean enabled = false
boolean originalsize = true
boolean focusrectangle = false
end type

type st_na from statictext within u_picture_display
integer width = 251
integer height = 252
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "This type of file (xxxxx) cannot be visually displayed"
boolean focusrectangle = false
end type

event clicked;parent.postevent("picture_clicked")

end event

type ole_control from u_ole_control within u_picture_display
integer taborder = 20
string binarykey = "u_picture_display.udo"
end type

event clicked;call super::clicked;parent.postevent("picture_clicked")

end event

type ole_browser from u_browser within u_picture_display
integer width = 736
integer height = 620
boolean border = false
borderstyle borderstyle = stylebox!
string binarykey = "u_picture_display.udo"
integer binaryindex = 1
end type

event clicked;call super::clicked;parent.postevent("picture_clicked")

end event

type p_picture from picture within u_picture_display
event leftdown pbm_lbuttondown
integer width = 960
integer height = 808
boolean focusrectangle = false
end type

event clicked;parent.postevent("picture_clicked")

end event


Start of PowerBuilder Binary Data Section : Do NOT Edit
0Cu_picture_display.bin 
2400000600e011cfd0e11ab1a1000000000000000000000000000000000003003e0009fffe00000006000000000000000000000001000000010000000000001000fffffffe00000000fffffffe0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdfffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff006f00520074006f004500200074006e00790072000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050016ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000fffffffe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00e011cfd0e11ab1a1000000000000000000000000000000000003003e0009fffe000000060000000000000000000000010000000100000000000010000000000200000001fffffffe0000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
23fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdfffffffefffffffefffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff006f00520074006f004500200074006e00790072000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050016ffffffffffffffff0000000100000000000000000000000000000000000000000000000000000000a21d384001ca002e00000003000001800000000000500003004f0042005800430054005300450052004d0041000000000000000000000000000000000000000000000000000000000000000000000000000000000102001affffffff00000002ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000009c00000000004200500043004f00530058004f00540041005200450047000000000000000000000000000000000000000000000000000000000000000000000000000000000001001affffffffffffffff000000038856f96111d0340ac0006ba9a205d74f00000000a21d384001ca002ea21d384001ca002e000000000000000000000000004f00430054004e004e00450053005400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001020012ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000030000009c000000000000000100000002fffffffe0000000400000005fffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000004c000010a4000010050000000100000005000000000000000000000000000000000000004c0000000000000000000000010057d0e011cf3573000869ae62122e2b00000008000000000000004c0002140100000000000000c046000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000003a00430057005c004e0049004f004400530057004d005c00630069006f0072006f00730000004c000010a4000010050000000100000005000000000000000000000000000000000000004c0000000000000000000000010057d0e011cf3573000869ae62122e2b00000008000000000000004c0002140100000000000000c046000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000005c006c003100760030002e0069000000200066012f00210163002e001602800c154f680061004e0065006d003d003d006b0022
2500290022006300200032006800650028003b0029000a000d000d007d0066000a006e007500740063006f00690020006e0078006500290028007d007b000a000d007500660063006e00690074006e006f00680020002900280077007b006e0069006f0064002e00770074007300740061000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1Cu_picture_display.bin 
End of PowerBuilder Binary Data Section : No Source Expected After This Point
