$PBExportHeader$u_treatment_results.sru
forward
global type u_treatment_results from u_tabpage
end type
type dw_properties from u_dw_pick_list within u_treatment_results
end type
type rte_treatment from u_rich_text_edit within u_treatment_results
end type
end forward

global type u_treatment_results from u_tabpage
integer width = 2912
integer height = 1164
string text = "Treatment"
dw_properties dw_properties
rte_treatment rte_treatment
end type
global u_treatment_results u_treatment_results

type variables
boolean initialized = false
u_component_treatment treatment
boolean first_time = true

end variables

forward prototypes
public function integer display_treatment ()
public function integer initialize (u_component_treatment puo_treatment)
public function integer initialize ()
public subroutine refresh ()
public function integer display_treatment_properties (str_treatment_description pstr_treatment)
end prototypes

public function integer display_treatment ();integer li_sts
str_treatment_description lstr_treatment
long ll_backcolor


if first_time then
	ll_backcolor = datalist.get_preference_int("SYSTEM", "treatment_review_background_color")
	if not isnull(ll_backcolor) then rte_treatment.set_background_color(ll_backcolor)

	first_time = false
end if

//rte_treatment.set_redraw(false)
li_sts = current_patient.treatments.treatment(lstr_treatment, treatment.treatment_id)

rte_treatment.clear_rtf()

rte_treatment.display_treatment(lstr_treatment.treatment_id)
rte_treatment.top()

//rte_treatment.set_redraw(true)

display_treatment_properties(lstr_treatment)

return 1

end function

public function integer initialize (u_component_treatment puo_treatment);
treatment = puo_treatment

dw_properties.width = 1029
dw_properties.height = height - 100
dw_properties.x = width - dw_properties.width - 20
dw_properties.y = 20

rte_treatment.width = dw_properties.x - 20
rte_treatment.height = height

return 1

end function

public function integer initialize ();
treatment = parent_tab.service.treatment

dw_properties.width = 1029
dw_properties.height = height - 100
dw_properties.x = width - dw_properties.width - 20
dw_properties.y = 20

rte_treatment.width = dw_properties.x - 20
rte_treatment.height = height

return 1

end function

public subroutine refresh ();
display_treatment()

end subroutine

public function integer display_treatment_properties (str_treatment_description pstr_treatment);Long			i,ll_rows
String		ls_user_id
Datetime		ldt_date
Long 			ll_progress_sequence
/* user defined */
str_progress_list lstr_progress
string ls_null
integer li_sts
integer li_index
string ls_last_ordered_by

setnull(ls_null)

dw_properties.reset()
li_index = 0

li_index += 1
dw_properties.object.title[li_index] = "Treatment Type"
dw_properties.object.attribute[li_index] = "treatment_type"
dw_properties.object.value[li_index] = datalist.treatment_type_description(pstr_treatment.treatment_type)

li_index += 1
dw_properties.object.title[li_index] = "Begin Date"
dw_properties.object.attribute[li_index] = "begin_date"
dw_properties.object.value[li_index] = string(pstr_treatment.begin_date)
dw_properties.object.clickable[li_index] = 1

li_index += 1
dw_properties.object.title[li_index] = "End Date"
dw_properties.object.attribute[li_index] = "end_date"
dw_properties.object.value[li_index] = string(pstr_treatment.end_date)
// Don't let the user change the end_date if the treatment is still open
if isnull(pstr_treatment.treatment_status) OR upper(pstr_treatment.treatment_status) = "OPEN" then
	dw_properties.object.clickable[li_index] = 0
else
	dw_properties.object.clickable[li_index] = 1
end if

li_index += 1
dw_properties.object.title[li_index] = "Ordered By"
dw_properties.object.attribute[li_index] = "ordered_by"
dw_properties.object.value[li_index] = user_list.user_full_name(pstr_treatment.ordered_by)
dw_properties.object.color[li_index] = user_list.user_color(pstr_treatment.ordered_by)

SELECT top 1 ordered_by
INTO :ls_last_ordered_by
FROM dbo.fn_patient_treatment_orders(:current_patient.cpr_id, :pstr_treatment.treatment_id)
ORDER BY order_sequence;
if not tf_check() then return -1
if sqlca.sqlnrows = 1 then
	li_index += 1
	dw_properties.object.title[li_index] = "Last Ordered By"
	dw_properties.object.attribute[li_index] = "lastorderedby"
	dw_properties.object.value[li_index] = user_list.user_full_name(ls_last_ordered_by)
	dw_properties.object.color[li_index] = user_list.user_color(ls_last_ordered_by)
end if

li_index += 1
dw_properties.object.title[li_index] = "Ordered For"
dw_properties.object.attribute[li_index] = "ordered_for"
dw_properties.object.value[li_index] = user_list.user_full_name(pstr_treatment.ordered_for)
dw_properties.object.color[li_index] = user_list.user_color(pstr_treatment.ordered_for)

li_index += 1
dw_properties.object.title[li_index] = "Created By"
dw_properties.object.attribute[li_index] = "created_by"
dw_properties.object.value[li_index] = user_list.user_full_name(pstr_treatment.created_by)
dw_properties.object.color[li_index] = user_list.user_color(pstr_treatment.created_by)

li_index += 1
dw_properties.object.title[li_index] = "Created"
dw_properties.object.attribute[li_index] = "created"
dw_properties.object.value[li_index] = string(pstr_treatment.created)


li_index += 1
dw_properties.object.title[li_index] = "Status"
dw_properties.object.attribute[li_index] = "treatment_status"
if isnull(pstr_treatment.treatment_status) OR upper(pstr_treatment.treatment_status) = "OPEN" then
	dw_properties.object.value[li_index] = "Open"
else
	dw_properties.object.value[li_index] = wordcap(pstr_treatment.treatment_status)
end if
if upper(pstr_treatment.treatment_status) = "CANCELLED" then
	dw_properties.object.clickable[li_index] = 1
elseif upper(pstr_treatment.treatment_status) = "CLOSED" then
	dw_properties.object.clickable[li_index] = 1
else
	dw_properties.object.clickable[li_index] = 0
end if


return 1


end function

on u_treatment_results.create
int iCurrent
call super::create
this.dw_properties=create dw_properties
this.rte_treatment=create rte_treatment
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.dw_properties
this.Control[iCurrent+2]=this.rte_treatment
end on

on u_treatment_results.destroy
call super::destroy
destroy(this.dw_properties)
destroy(this.rte_treatment)
end on

type dw_properties from u_dw_pick_list within u_treatment_results
integer x = 1874
integer y = 16
integer width = 1029
integer height = 928
integer taborder = 20
string dataobject = "dw_attribute_value_display_list"
end type

event clicked;call super::clicked;str_popup popup
str_popup_return popup_return
datetime ldt_begin_date
integer li_sts
string ls_attribute
integer li_clickable
string ls_old_value
string ls_new_value
string ls_null

setnull(ls_null)

if isnull(row) or row <= 0 then return

ls_attribute = object.attribute[row]
li_clickable = object.clickable[row]
ls_old_value = object.value[row]

if isnull(li_clickable) or li_clickable <= 0 then return

CHOOSE CASE lower(ls_attribute)
	CASE "begin_date"
		popup.title = "Begin Date/Time"
		popup.item = ls_old_value
		
		openwithparm(w_pop_prompt_date_time, popup)
		popup_return = message.powerobjectparm
		if popup_return.item_count <> 2 then return
		
		ldt_begin_date = datetime(date(popup_return.items[1]), time(popup_return.items[2]))
		ls_new_value = string(ldt_begin_date)
		
		li_sts = current_patient.treatments.modify_treatment(treatment.treatment_id, ls_attribute, ls_new_value)
		if li_sts <= 0 then return
		
		refresh()
	CASE "end_date"
		popup.title = "End Date/Time"
		popup.item = ls_old_value
		
		openwithparm(w_pop_prompt_date_time, popup)
		popup_return = message.powerobjectparm
		if popup_return.item_count <> 2 then return
		
		ldt_begin_date = datetime(date(popup_return.items[1]), time(popup_return.items[2]))
		ls_new_value = string(ldt_begin_date)
		
		li_sts = current_patient.treatments.modify_treatment(treatment.treatment_id, ls_attribute, ls_new_value)
		if li_sts <= 0 then return
		
		refresh()
	CASE "treatment_status"
		if lower(ls_old_value) = "cancelled" then
			openwithparm(w_pop_yes_no, "Do you wish to un-cancel this treatment?")
			popup_return = message.powerobjectparm
			if popup_return.item <> "YES" then return
			
			treatment.set_progress('UNCancelled', ls_null)
			
			refresh()
			return
		elseif lower(ls_old_value) = "closed" then
			openwithparm(w_pop_yes_no, "Do you wish to Reopen this treatment?")
			popup_return = message.powerobjectparm
			if popup_return.item <> "YES" then return
			
			treatment.set_progress('Reopen', ls_null)
			
			refresh()
			return
		end if
END CHOOSE



end event

type rte_treatment from u_rich_text_edit within u_treatment_results
integer width = 1861
integer height = 1044
integer taborder = 10
string binarykey = "u_treatment_results.udo"
end type


Start of PowerBuilder Binary Data Section : Do NOT Edit
00u_treatment_results.bin 
2C00001800e011cfd0e11ab1a1000000000000000000000000000000000003003e0009fffe000000060000000000000000000000010000000100000000000010000000000200000001fffffffe0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd00000008fffffffe0000000400000005000000060000000700000009fffffffe0000000afffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff006f00520074006f004500200074006e00790072000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050016ffffffffffffffff0000000300000000000000000000000000000000000000000000000000000000c9a98a8001cac76b0000000300000cc00000000000500003004c004200430049004e0045004500530045004b000000590000000000000000000000000000000000000000000000000000000000000000000000000002001cffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000500003004f0042005800430054005300450052004d0041000000000000000000000000000000000000000000000000000000000000000000000000000000000002001affffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000010000087b00000000004200500043004f00530058004f00540041005200450047000000000000000000000000000000000000000000000000000000000000000000000000000000000101001a00000002000000010000000426bd990111dde7d0130041aa7c6650d300000000c9a98a8001cac76bc9a98a8001cac76b000000000000000000000000fffffffe00000002000000030000000400000005000000060000000700000008000000090000000a0000000b0000000c0000000d0000000e0000000f000000100000001100000012000000130000001400000015000000160000001700000018000000190000001a0000001b0000001c0000001d0000001e0000001f000000200000002100000022fffffffe0000002400000025000000260000002700000028000000290000002a0000002b0000002c0000002d0000002e0000002f000000300000003100000032fffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
2Affffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff005000540036002d00310034003600320039003700310036000000390000000000000000000000000000000000000000000000000000000000000000000000000000fffe0002020526bd990111dde7d0130041aa7c6650d300000001fb8f0821101b01640008ed8413c72e2b000000300000084b0000003a00000100000001d800000101000001e000000102000001e800000103000001f000000104000001f8000001050000020000000106000002080000010700000210000001080000021800000109000002200000010a000002280000010b000002300000010c000002380000010d000002400000010e000002480000010f00000250000001100000025800000111000002600000011200000268000001130000027000000114000002ac00000115000002b400000116000002bc00000117000002c400000118000002cc00000119000002d40000011a000002dc0000011b000002e40000011c000002ec0000011d000002f40000011e000002fc0000011f0000030c0000012000000314000001210000031c0000012200000324000001230000032c0000012400000334000001250000033c0000012600000344000001270000034c0000012800000354000001290000035c0000012a000003640000012b0000036c0000012c000003740000012d0000037c0000012e000003840000012f0000038c0000013000000394000001310000039c00000132000003a800000133000003b000000134000003b800000135000003c000000136000003c800000137000003d000000138000003d800000000000003e000000003000200000000000300002a110000000300001afa00000003000000490000000200000001000000020000000100000002000000010000000b0000000000000002000000000000000b0000ffff0000000b0000ffff0000000200000000000000020000006400000002000000030000000b000000000000000b0000ffff00000002000000000000000b0000ffff0000000b000000000000000800000031505c3a4352474f525c317e4149454854317e414d5458545c7e5458455c302e315c6e694252454d414e4143494454562e0000000000000002000000030000000300002fd00000000300003de000000003000005a000000003000005a000000003000005a000000003000005a000000002000000640000000b000000000000000b0000ffff0000000800000006616972410000006c000000020000000c0000000b000000000000000b000000000000000b000000000000000b0000000000000002000000000000000300ffffff0000000200000000000000020000006400000002000000000000000200000020000000020000000000000002000000140000000200000000000000020000000000000002000000000000000200000000000000020000000000000008000000010000000000000002000000010000000b0000ffff0000000b0000ffff0000000b000000000000000200000000000000020000000100000002000000000000003a00000000000000010001330000000a006c6c61006e75776f32006f640d000001770000007764726f6d7061720065646f00000112000000106d726f66657374617463656c006e6f69000001090000000e65646968656c65736f6974630108006e00090000646500006f6d7469280065640d0000016c00000073656e69696361700074676e000001190000000c656761706772616d00726e69000001070000000d746e6f63636c6f727372616800012d0000000800646e690072746e6500011e00000009006e6f66006d616e74011a0065000c000061700000616d65676e696772010e0062000d00006c6300006863706972646c6930006e6508000001690000006e65646e180062740c000001700000006d656761696772611500746e0a00000170000000776567616874646900010b0000000d00756f6d006f70657365746e6901060072000a00006162000074736b6300656c790000013400000015747865746d61726672616d656c72656b73656e6900012f0000000800646e690074746e650001270000000c006e696c0061707365676e696300010c0000000b006f6f7a006361666d00726f740000010a0000000e65736e696f697472646f6d6e012a0065000e00007266000064656d61617473690065636e000001130000001270737476646c6c656974636972616e6f01030079000c0000735f00006b636f74706f7270013600730010000061700000726f6567746e65696f6974610135006e00170000696600006c646c65746b6e696567726172616d747372656b0001210000000b006e6f6600617469740063696c0000011000000009657a697365646f6d0001050000000c00726f620073726564656c79740001370000000e006761700065697665797473772600656c0a000001610000006e67696c746e656d0001240000000900736162006e696c6501160065000b00006170000065686567746867690001250000000c0078657400636b6274726f6c6f0001230000000e006e6f6600646e7574696c72652200656e0f0000016600000073746e6f6b69727472687465011f0075000900006f6600006973746e1100657a0700000174000000656b6261012b0079000f0000726600006c656d6177656e69687464690001290000000b0061726600
207473656d00656c7900000101000000097478655f78746e6500012000000009006e6f66006c6f62740102006400090000655f00006e657478380079740d0000016600000073746e6f697474650073676e0000011d0000000c6e6972706c6f63740073726f000001170000000c656761706772616d006c6e690000010d000000097765697665646f6d00012c0000000800646e69006c746e6500012e0000000900646e690066746e650131006c00050000657400001c0074780c00000170000000746e69727366666f1b0074650a00000170000000746e69726d6f6f7a0001140000000b0072637300626c6c6f007372610000010400000009676e616c65676175000100000000090065765f006f697372010f006e000d00006c630000697370696e696c6200007367000000000002000000002a1100001afa000000490000000000ffffff0100010100000100010100000064000001000003000100005c3a4330474f5250317e41524548545c7e414d4958545c3154584554302e317e6e69425c454d415c4143495254562e4e03000044002fd000003de0000005a0000005a0000005a0000005a00000006400724105010c6c616900000000ff0000000000ffff000064000000200000001400000000000000000001000000010100010100000020000000dc0000030e0001050000000000000000020000005c000000010000010100010000000100000000009f000000010001000000000000000000000000000000000000ff1050000000000001900000000000412202006c616972000000000000000000000000000000000000000000000000010000000100010000000000000000000000000020006400006f00430074006e006e00650073007400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001020012ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000023000003db000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400046e01000108dc01b8010d4a16260111011a940170011f0227de0123012c4c01280130ba39960135003e040100000000000000000000000041000000690072006c0061000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4000000010000040900010000010006002e000000ffffb7000000000000000000000000010000000000000000000000000000000000000000000100000000000000000000000000010000000100010000000100000000000000000000000000000000005400000030000001000000000000000000000000000000000000000000400000000000000100000000000000000000000000000024000000010000010000000000ff1000000000000001900000000000410202006c6169720000000000000000000000000000000000000000000000000000000000000000000000000000000041000000690072006c006100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000005000000000000000002000640000000f00046e01000108dc01b8010d4a16260111011a940170011f0227de0123012c4c01280130ba39960135013e04010900010000010006002e000000ffffb700000000000000000000000000000000000012000000000000000000000000000000000000000000000000004e005b0072006f0061006d005d006c000100000000004e0000003200000000003700000037023702d0023702e000002fa000003da005a0052005a00500800f020000000001000000000000001b000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10u_treatment_results.bin 
End of PowerBuilder Binary Data Section : No Source Expected After This Point
